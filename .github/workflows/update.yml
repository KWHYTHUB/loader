name: Update Bin

on:
  workflow_dispatch:
  push:
    tags:
    - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:      
    - uses: actions/checkout@v2
      with:
        repository: geode-sdk/bin
        path: bin
        submodules: recursive
        token: '${{ secrets.GEODE_BOT_PUSH_BIN_TOKEN }}'

    - name: Download Windows artifact
      uses: dawidd6/action-download-artifact@v2
      id: dlwin
      with:
        github_token: ${{secrets.GEODE_BOT_PUSH_BIN_TOKEN}}
        workflow: build.yml
        workflow_conclusion: success
        branch: main
        name: "Windows Loader Binary + Libraries"
        path: '${{ github.workspace }}/windows'
        
    - name: Download MacOS artifact
      uses: dawidd6/action-download-artifact@v2
      id: dlmac
      with:
        github_token: ${{secrets.GEODE_BOT_PUSH_BIN_TOKEN}}
        workflow: build.yml
        workflow_conclusion: success
        branch: main
        name: "macOS Loader Binary + Libraries"
        path: '${{ github.workspace }}/macos'
      
    - name: Move windows files to bin
      if: steps.dlwin.outcome == 'success'
      id: mvwin
      shell: bash
      working-directory: ${{ github.workspace }}
      run: |
        mv "${{ github.workspace }}/windows"/**/*.dll ${{ github.workspace }}/windows/**/*.lib ${{ github.workspace }}/bin/windows
        mv ${{ github.workspace }}/windows/Gen ${{ github.workspace }}/bin/windows/gen
        
    - name: Move macos files to bin
      if: steps.dlmac.outcome == 'success'
      id: mvmac
      shell: bash
      working-directory: ${{ github.workspace }}
      run: |
        mv "${{ github.workspace }}/macos"/**/*.dylib ${{ github.workspace }}/macos/**/*.a ${{ github.workspace }}/bin/macos
        mv ${{ github.workspace }}/macos/gen ${{ github.workspace }}/bin/macos/gen
        
    - name: Commit and push to bin
      if: steps.mvwin.outcome == 'success' && steps.mvmac.outcome == 'success'
      working-directory: ${{ github.workspace }}/bin
      run: |
        git config --local user.email "${{ secrets.GEODE_BOT_EMAIL }}"
        git config --local user.name "GeodeBot"
        git commit -am "Auto-update ${{ matrix.config.name }} from ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
        git push "https://GeodeBot:${{ secrets.GEODE_BOT_PUSH_BIN_TOKEN}}@github.com/geode-sdk/bin.git" main
